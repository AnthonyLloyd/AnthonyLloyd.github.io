---
layout: post
title: "F# Modularity From Lazy Evaluation Example - Richardson Extrapolation"
tags: [modularity,higher-order,lazy evaluation]
description: "An F# example of how higher-order functions together with lazy evaluation can reduce complexity and lead to more modular software"
keywords: f#, fsharp, functional, higher-order functions, lazy evaluation, modularity
---
<p>This is an F# example of how higher-order functions together with lazy evaluation can reduce complexity and lead to more modular software.</p>
<h2>Background</h2>
<p>Richardson extrapolation is a method of combining multiple function estimates to increase estimate accuracy.
In this post we will cover estimating the derivative and the intergral of a function to an arbitrary accuracy.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l">1: </span>
<span class="l">2: </span>
<span class="l">3: </span>
<span class="l">4: </span>
<span class="l">5: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="c">/// Derivative estimate</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs22', 49)" onmouseover="showTip(event, 'fs22', 49)" class="f">derivativeEstimate</span> <span onmouseout="hideTip(event, 'fs23', 50)" onmouseover="showTip(event, 'fs23', 50)" class="f">f</span> <span onmouseout="hideTip(event, 'fs24', 51)" onmouseover="showTip(event, 'fs24', 51)" class="i">x</span> <span onmouseout="hideTip(event, 'fs25', 52)" onmouseover="showTip(event, 'fs25', 52)" class="i">h</span> <span class="o">=</span> (<span onmouseout="hideTip(event, 'fs23', 53)" onmouseover="showTip(event, 'fs23', 53)" class="f">f</span>(<span onmouseout="hideTip(event, 'fs24', 54)" onmouseover="showTip(event, 'fs24', 54)" class="i">x</span><span class="o">+</span><span onmouseout="hideTip(event, 'fs25', 55)" onmouseover="showTip(event, 'fs25', 55)" class="i">h</span>)<span class="o">-</span><span onmouseout="hideTip(event, 'fs23', 56)" onmouseover="showTip(event, 'fs23', 56)" class="f">f</span>(<span onmouseout="hideTip(event, 'fs24', 57)" onmouseover="showTip(event, 'fs24', 57)" class="i">x</span><span class="o">-</span><span onmouseout="hideTip(event, 'fs25', 58)" onmouseover="showTip(event, 'fs25', 58)" class="i">h</span>))<span class="o">/</span><span onmouseout="hideTip(event, 'fs25', 59)" onmouseover="showTip(event, 'fs25', 59)" class="i">h</span><span class="o">*</span><span class="n">0.5</span>

<span class="c">/// Integral estimate (h = (b-a)/n where n is an integer)</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs26', 60)" onmouseover="showTip(event, 'fs26', 60)" class="f">integralEstimate</span> <span onmouseout="hideTip(event, 'fs23', 61)" onmouseover="showTip(event, 'fs23', 61)" class="f">f</span> <span onmouseout="hideTip(event, 'fs27', 62)" onmouseover="showTip(event, 'fs27', 62)" class="i">a</span> <span onmouseout="hideTip(event, 'fs28', 63)" onmouseover="showTip(event, 'fs28', 63)" class="i">b</span> <span onmouseout="hideTip(event, 'fs25', 64)" onmouseover="showTip(event, 'fs25', 64)" class="i">h</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs25', 65)" onmouseover="showTip(event, 'fs25', 65)" class="i">h</span><span class="o">*</span>(<span onmouseout="hideTip(event, 'fs23', 66)" onmouseover="showTip(event, 'fs23', 66)" class="f">f</span> <span onmouseout="hideTip(event, 'fs27', 67)" onmouseover="showTip(event, 'fs27', 67)" class="i">a</span><span class="o">+</span><span onmouseout="hideTip(event, 'fs23', 68)" onmouseover="showTip(event, 'fs23', 68)" class="f">f</span> <span onmouseout="hideTip(event, 'fs28', 69)" onmouseover="showTip(event, 'fs28', 69)" class="i">b</span>)<span class="o">*</span><span class="n">0.5</span> <span class="o">+</span> <span onmouseout="hideTip(event, 'fs25', 70)" onmouseover="showTip(event, 'fs25', 70)" class="i">h</span><span class="o">*</span><span onmouseout="hideTip(event, 'fs29', 71)" onmouseover="showTip(event, 'fs29', 71)" class="t">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs30', 72)" onmouseover="showTip(event, 'fs30', 72)" class="f">sumBy</span> <span onmouseout="hideTip(event, 'fs23', 73)" onmouseover="showTip(event, 'fs23', 73)" class="f">f</span> {<span onmouseout="hideTip(event, 'fs27', 74)" onmouseover="showTip(event, 'fs27', 74)" class="i">a</span><span class="o">+</span><span onmouseout="hideTip(event, 'fs25', 75)" onmouseover="showTip(event, 'fs25', 75)" class="i">h</span><span class="o">..</span><span onmouseout="hideTip(event, 'fs25', 76)" onmouseover="showTip(event, 'fs25', 76)" class="i">h</span><span class="o">*</span><span class="n">2.0</span><span class="o">..</span><span onmouseout="hideTip(event, 'fs28', 77)" onmouseover="showTip(event, 'fs28', 77)" class="i">b</span>}
</code></pre></td>
</tr>
</table>
<p>Both the derivative and intergal estimate can be shown to have an error term that has even powers in h.</p>
<p><span class="math">\[Actual = Estimate(h) + e_1 h^2 + e_2 h^4 + \cdots\]</span></p>
<p>Richardson extrapolation combines multiple estimates to eliminate the lower power error terms.</p>
<p><span class="math">\[R_{ij} =
\left\{
    \begin{align}
        &amp; Estimate\left(\frac{h}{2^i}\right) &amp; j=0 \\
        &amp; \frac{4^j R_{i,j-1} - R_{i-1,j-1}}{4^j-1} &amp; i \geq j, j \ne 0 \\
    \end{align}
\right.\]</span></p>
<p>For small h this rapidly improves the accuracy of the estimate.</p>
<p><span class="math">\[Actual = R_{ij} + \hat{e}_1 h^{2j+2} + \hat{e}_2 h^{2j+4} + \cdots\]</span></p>
<p>This leads to a triangle of improving estimates as we move down and to the right.</p>
<p><span class="math">\[\begin{matrix}
R_{00} &amp; \\
&amp; \searrow &amp; \\
R_{10} &amp; \rightarrow &amp; R_{11} \\
&amp; \searrow &amp; &amp; \searrow \\
R_{20} &amp; \rightarrow &amp; R_{21} &amp; \rightarrow &amp; R_{22} \\
\vdots &amp; &amp; \vdots &amp; &amp; \vdots &amp; \ddots \\
\end{matrix}\]</span></p>
<p>The stopping criteria is usually that <span class="math">\(|R_{n-2,n-2}-R_{n-1,n-1}|\)</span> and <span class="math">\(|R_{n-1,n-1}-R_{n,n}|\)</span> are within a desired accuracy.</p>
<h2>First attempt</h2>
<p>The first implementation attempt will be done without using functional techniques.</p>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
<span class="l">27: </span>
<span class="l">28: </span>
<span class="l">29: </span>
<span class="l">30: </span>
<span class="l">31: </span>
<span class="l">32: </span>
<span class="l">33: </span>
<span class="l">34: </span>
<span class="l">35: </span>
<span class="l">36: </span>
<span class="l">37: </span>
<span class="l">38: </span>
<span class="l">39: </span>
<span class="l">40: </span>
<span class="l">41: </span>
<span class="l">42: </span>
<span class="l">43: </span>
<span class="l">44: </span>
<span class="l">45: </span>
<span class="l">46: </span>
<span class="l">47: </span>
<span class="l">48: </span>
<span class="l">49: </span>
<span class="l">50: </span>
<span class="l">51: </span>
<span class="l">52: </span>
<span class="l">53: </span>
<span class="l">54: </span>
<span class="l">55: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="c">/// Stopping criteria for a given accuracy and list of Richardson estimates.</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs31', 78)" onmouseover="showTip(event, 'fs31', 78)" class="f">stoppingCriteriaNonFunctional</span> <span onmouseout="hideTip(event, 'fs32', 79)" onmouseover="showTip(event, 'fs32', 79)" class="i">tol</span> (<span onmouseout="hideTip(event, 'fs33', 80)" onmouseover="showTip(event, 'fs33', 80)" class="i">rows</span><span class="o">:</span><span onmouseout="hideTip(event, 'fs34', 81)" onmouseover="showTip(event, 'fs34', 81)" class="t">List</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs35', 82)" onmouseover="showTip(event, 'fs35', 82)" class="t">float</span> <span onmouseout="hideTip(event, 'fs36', 83)" onmouseover="showTip(event, 'fs36', 83)" class="t">array</span><span class="o">&gt;</span>) <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs37', 84)" onmouseover="showTip(event, 'fs37', 84)" class="i">c</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs33', 85)" onmouseover="showTip(event, 'fs33', 85)" class="i">rows</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs38', 86)" onmouseover="showTip(event, 'fs38', 86)" class="i">Count</span>
    <span onmouseout="hideTip(event, 'fs37', 87)" onmouseover="showTip(event, 'fs37', 87)" class="i">c</span><span class="o">&gt;</span><span class="n">2</span> <span class="o">&amp;&amp;</span>
    <span onmouseout="hideTip(event, 'fs39', 88)" onmouseover="showTip(event, 'fs39', 88)" class="f">abs</span>(<span onmouseout="hideTip(event, 'fs33', 89)" onmouseover="showTip(event, 'fs33', 89)" class="i">rows</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs37', 90)" onmouseover="showTip(event, 'fs37', 90)" class="i">c</span><span class="o">-</span><span class="n">3</span>]<span class="o">.</span>[<span onmouseout="hideTip(event, 'fs37', 91)" onmouseover="showTip(event, 'fs37', 91)" class="i">c</span><span class="o">-</span><span class="n">3</span>]<span class="o">-</span><span onmouseout="hideTip(event, 'fs33', 92)" onmouseover="showTip(event, 'fs33', 92)" class="i">rows</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs37', 93)" onmouseover="showTip(event, 'fs37', 93)" class="i">c</span><span class="o">-</span><span class="n">2</span>]<span class="o">.</span>[<span onmouseout="hideTip(event, 'fs37', 94)" onmouseover="showTip(event, 'fs37', 94)" class="i">c</span><span class="o">-</span><span class="n">2</span>])<span class="o">&lt;=</span><span onmouseout="hideTip(event, 'fs32', 95)" onmouseover="showTip(event, 'fs32', 95)" class="i">tol</span> <span class="o">&amp;&amp;</span>
    <span onmouseout="hideTip(event, 'fs39', 96)" onmouseover="showTip(event, 'fs39', 96)" class="f">abs</span>(<span onmouseout="hideTip(event, 'fs33', 97)" onmouseover="showTip(event, 'fs33', 97)" class="i">rows</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs37', 98)" onmouseover="showTip(event, 'fs37', 98)" class="i">c</span><span class="o">-</span><span class="n">2</span>]<span class="o">.</span>[<span onmouseout="hideTip(event, 'fs37', 99)" onmouseover="showTip(event, 'fs37', 99)" class="i">c</span><span class="o">-</span><span class="n">2</span>]<span class="o">-</span><span onmouseout="hideTip(event, 'fs33', 100)" onmouseover="showTip(event, 'fs33', 100)" class="i">rows</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs37', 101)" onmouseover="showTip(event, 'fs37', 101)" class="i">c</span><span class="o">-</span><span class="n">1</span>]<span class="o">.</span>[<span onmouseout="hideTip(event, 'fs37', 102)" onmouseover="showTip(event, 'fs37', 102)" class="i">c</span><span class="o">-</span><span class="n">1</span>])<span class="o">&lt;=</span><span onmouseout="hideTip(event, 'fs32', 103)" onmouseover="showTip(event, 'fs32', 103)" class="i">tol</span>

<span class="c">/// The Richardson formula for a function estimate that has even power error term.</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs40', 104)" onmouseover="showTip(event, 'fs40', 104)" class="f">richardsonFormula</span> <span onmouseout="hideTip(event, 'fs41', 105)" onmouseover="showTip(event, 'fs41', 105)" class="i">currentRowR</span> <span onmouseout="hideTip(event, 'fs42', 106)" onmouseover="showTip(event, 'fs42', 106)" class="i">previousRowR</span> <span onmouseout="hideTip(event, 'fs43', 107)" onmouseover="showTip(event, 'fs43', 107)" class="i">pow4</span> <span class="o">=</span>
     (<span onmouseout="hideTip(event, 'fs41', 108)" onmouseover="showTip(event, 'fs41', 108)" class="i">currentRowR</span><span class="o">*</span><span onmouseout="hideTip(event, 'fs43', 109)" onmouseover="showTip(event, 'fs43', 109)" class="i">pow4</span><span class="o">-</span><span onmouseout="hideTip(event, 'fs42', 110)" onmouseover="showTip(event, 'fs42', 110)" class="i">previousRowR</span>)<span class="o">/</span>(<span onmouseout="hideTip(event, 'fs43', 111)" onmouseover="showTip(event, 'fs43', 111)" class="i">pow4</span><span class="o">-</span><span class="n">1.0</span>)

<span class="c">/// Derivative accurate to tol using Richardson extrapolation </span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs44', 112)" onmouseover="showTip(event, 'fs44', 112)" class="f">derivativeNonFunctional</span> <span onmouseout="hideTip(event, 'fs32', 113)" onmouseover="showTip(event, 'fs32', 113)" class="i">tol</span> <span onmouseout="hideTip(event, 'fs45', 114)" onmouseover="showTip(event, 'fs45', 114)" class="i">h0</span> <span onmouseout="hideTip(event, 'fs23', 115)" onmouseover="showTip(event, 'fs23', 115)" class="f">f</span> <span onmouseout="hideTip(event, 'fs24', 116)" onmouseover="showTip(event, 'fs24', 116)" class="i">x</span> <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs46', 117)" onmouseover="showTip(event, 'fs46', 117)" class="i">richardsonRows</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs34', 118)" onmouseover="showTip(event, 'fs34', 118)" class="t">List</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs35', 119)" onmouseover="showTip(event, 'fs35', 119)" class="t">float</span> <span onmouseout="hideTip(event, 'fs36', 120)" onmouseover="showTip(event, 'fs36', 120)" class="t">array</span><span class="o">&gt;</span>()
    <span onmouseout="hideTip(event, 'fs46', 121)" onmouseover="showTip(event, 'fs46', 121)" class="i">richardsonRows</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs47', 122)" onmouseover="showTip(event, 'fs47', 122)" class="f">Add</span> ([|<span onmouseout="hideTip(event, 'fs22', 123)" onmouseover="showTip(event, 'fs22', 123)" class="f">derivativeEstimate</span> <span onmouseout="hideTip(event, 'fs23', 124)" onmouseover="showTip(event, 'fs23', 124)" class="f">f</span> <span onmouseout="hideTip(event, 'fs24', 125)" onmouseover="showTip(event, 'fs24', 125)" class="i">x</span> <span onmouseout="hideTip(event, 'fs45', 126)" onmouseover="showTip(event, 'fs45', 126)" class="i">h0</span>|])
    <span class="k">let</span> <span class="k">mutable</span> <span onmouseout="hideTip(event, 'fs48', 127)" onmouseover="showTip(event, 'fs48', 127)" class="v">h</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs45', 128)" onmouseover="showTip(event, 'fs45', 128)" class="i">h0</span><span class="o">*</span><span class="n">0.5</span>
    <span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'fs49', 129)" onmouseover="showTip(event, 'fs49', 129)" class="f">run</span> () <span class="o">=</span>
        <span class="k">let</span> <span onmouseout="hideTip(event, 'fs50', 130)" onmouseover="showTip(event, 'fs50', 130)" class="i">lastRow</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs29', 131)" onmouseover="showTip(event, 'fs29', 131)" class="t">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs51', 132)" onmouseover="showTip(event, 'fs51', 132)" class="f">last</span> <span onmouseout="hideTip(event, 'fs46', 133)" onmouseover="showTip(event, 'fs46', 133)" class="i">richardsonRows</span>
        <span class="k">let</span> <span onmouseout="hideTip(event, 'fs52', 134)" onmouseover="showTip(event, 'fs52', 134)" class="i">row</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs53', 135)" onmouseover="showTip(event, 'fs53', 135)" class="t">Array</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs54', 136)" onmouseover="showTip(event, 'fs54', 136)" class="f">zeroCreate</span> (<span onmouseout="hideTip(event, 'fs53', 137)" onmouseover="showTip(event, 'fs53', 137)" class="t">Array</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs55', 138)" onmouseover="showTip(event, 'fs55', 138)" class="f">length</span> <span onmouseout="hideTip(event, 'fs50', 139)" onmouseover="showTip(event, 'fs50', 139)" class="i">lastRow</span><span class="o">+</span><span class="n">1</span>)
        <span onmouseout="hideTip(event, 'fs52', 140)" onmouseover="showTip(event, 'fs52', 140)" class="i">row</span><span class="o">.</span>[<span class="n">0</span>] <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs22', 141)" onmouseover="showTip(event, 'fs22', 141)" class="f">derivativeEstimate</span> <span onmouseout="hideTip(event, 'fs23', 142)" onmouseover="showTip(event, 'fs23', 142)" class="f">f</span> <span onmouseout="hideTip(event, 'fs24', 143)" onmouseover="showTip(event, 'fs24', 143)" class="i">x</span> <span onmouseout="hideTip(event, 'fs48', 144)" onmouseover="showTip(event, 'fs48', 144)" class="v">h</span>
        <span class="k">let</span> <span class="k">mutable</span> <span onmouseout="hideTip(event, 'fs56', 145)" onmouseover="showTip(event, 'fs56', 145)" class="v">pow4</span> <span class="o">=</span> <span class="n">4.0</span>
        <span class="k">for</span> <span onmouseout="hideTip(event, 'fs57', 146)" onmouseover="showTip(event, 'fs57', 146)" class="i">i</span> <span class="o">=</span> <span class="n">0</span> <span class="k">to</span> <span onmouseout="hideTip(event, 'fs53', 147)" onmouseover="showTip(event, 'fs53', 147)" class="t">Array</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs55', 148)" onmouseover="showTip(event, 'fs55', 148)" class="f">length</span> <span onmouseout="hideTip(event, 'fs50', 149)" onmouseover="showTip(event, 'fs50', 149)" class="i">lastRow</span><span class="o">-</span><span class="n">1</span> <span class="k">do</span>
            <span onmouseout="hideTip(event, 'fs52', 150)" onmouseover="showTip(event, 'fs52', 150)" class="i">row</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs57', 151)" onmouseover="showTip(event, 'fs57', 151)" class="i">i</span><span class="o">+</span><span class="n">1</span>] <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs40', 152)" onmouseover="showTip(event, 'fs40', 152)" class="f">richardsonFormula</span> <span onmouseout="hideTip(event, 'fs52', 153)" onmouseover="showTip(event, 'fs52', 153)" class="i">row</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs57', 154)" onmouseover="showTip(event, 'fs57', 154)" class="i">i</span>] <span onmouseout="hideTip(event, 'fs50', 155)" onmouseover="showTip(event, 'fs50', 155)" class="i">lastRow</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs57', 156)" onmouseover="showTip(event, 'fs57', 156)" class="i">i</span>] <span onmouseout="hideTip(event, 'fs56', 157)" onmouseover="showTip(event, 'fs56', 157)" class="v">pow4</span>
            <span onmouseout="hideTip(event, 'fs56', 158)" onmouseover="showTip(event, 'fs56', 158)" class="v">pow4</span> <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs56', 159)" onmouseover="showTip(event, 'fs56', 159)" class="v">pow4</span><span class="o">*</span><span class="n">4.0</span>
        <span class="k">if</span> <span onmouseout="hideTip(event, 'fs31', 160)" onmouseover="showTip(event, 'fs31', 160)" class="f">stoppingCriteriaNonFunctional</span> <span onmouseout="hideTip(event, 'fs32', 161)" onmouseover="showTip(event, 'fs32', 161)" class="i">tol</span> <span onmouseout="hideTip(event, 'fs46', 162)" onmouseover="showTip(event, 'fs46', 162)" class="i">richardsonRows</span> <span class="k">then</span> <span onmouseout="hideTip(event, 'fs53', 163)" onmouseover="showTip(event, 'fs53', 163)" class="t">Array</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs58', 164)" onmouseover="showTip(event, 'fs58', 164)" class="f">last</span> <span onmouseout="hideTip(event, 'fs50', 165)" onmouseover="showTip(event, 'fs50', 165)" class="i">lastRow</span>
        <span class="k">else</span>
            <span onmouseout="hideTip(event, 'fs46', 166)" onmouseover="showTip(event, 'fs46', 166)" class="i">richardsonRows</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs47', 167)" onmouseover="showTip(event, 'fs47', 167)" class="f">Add</span> <span onmouseout="hideTip(event, 'fs52', 168)" onmouseover="showTip(event, 'fs52', 168)" class="i">row</span>
            <span onmouseout="hideTip(event, 'fs48', 169)" onmouseover="showTip(event, 'fs48', 169)" class="v">h</span><span class="o">&lt;-</span><span onmouseout="hideTip(event, 'fs48', 170)" onmouseover="showTip(event, 'fs48', 170)" class="v">h</span><span class="o">*</span><span class="n">0.5</span>
            <span onmouseout="hideTip(event, 'fs49', 171)" onmouseover="showTip(event, 'fs49', 171)" class="f">run</span>()
    <span onmouseout="hideTip(event, 'fs49', 172)" onmouseover="showTip(event, 'fs49', 172)" class="f">run</span>()
    
<span class="c">/// Iterative integral estimate (h is half the value used in the previous estimate)</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs59', 173)" onmouseover="showTip(event, 'fs59', 173)" class="f">integralEstimateIterative</span> <span onmouseout="hideTip(event, 'fs23', 174)" onmouseover="showTip(event, 'fs23', 174)" class="f">f</span> <span onmouseout="hideTip(event, 'fs27', 175)" onmouseover="showTip(event, 'fs27', 175)" class="i">a</span> <span onmouseout="hideTip(event, 'fs28', 176)" onmouseover="showTip(event, 'fs28', 176)" class="i">b</span> <span onmouseout="hideTip(event, 'fs60', 177)" onmouseover="showTip(event, 'fs60', 177)" class="i">previousEstimate</span> <span onmouseout="hideTip(event, 'fs25', 178)" onmouseover="showTip(event, 'fs25', 178)" class="i">h</span> <span class="o">=</span>
    <span onmouseout="hideTip(event, 'fs60', 179)" onmouseover="showTip(event, 'fs60', 179)" class="i">previousEstimate</span><span class="o">*</span><span class="n">0.5</span><span class="o">+</span><span onmouseout="hideTip(event, 'fs25', 180)" onmouseover="showTip(event, 'fs25', 180)" class="i">h</span><span class="o">*</span><span onmouseout="hideTip(event, 'fs29', 181)" onmouseover="showTip(event, 'fs29', 181)" class="t">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs30', 182)" onmouseover="showTip(event, 'fs30', 182)" class="f">sumBy</span> <span onmouseout="hideTip(event, 'fs23', 183)" onmouseover="showTip(event, 'fs23', 183)" class="f">f</span> {<span onmouseout="hideTip(event, 'fs27', 184)" onmouseover="showTip(event, 'fs27', 184)" class="i">a</span><span class="o">+</span><span onmouseout="hideTip(event, 'fs25', 185)" onmouseover="showTip(event, 'fs25', 185)" class="i">h</span><span class="o">..</span><span onmouseout="hideTip(event, 'fs25', 186)" onmouseover="showTip(event, 'fs25', 186)" class="i">h</span><span class="o">*</span><span class="n">2.0</span><span class="o">..</span><span onmouseout="hideTip(event, 'fs28', 187)" onmouseover="showTip(event, 'fs28', 187)" class="i">b</span>}
    
<span class="c">/// Intergral accurate to tol using Richardson extrapolation </span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs61', 188)" onmouseover="showTip(event, 'fs61', 188)" class="f">integralNonFunctional</span> <span onmouseout="hideTip(event, 'fs32', 189)" onmouseover="showTip(event, 'fs32', 189)" class="i">tol</span> <span onmouseout="hideTip(event, 'fs23', 190)" onmouseover="showTip(event, 'fs23', 190)" class="f">f</span> <span onmouseout="hideTip(event, 'fs27', 191)" onmouseover="showTip(event, 'fs27', 191)" class="i">a</span> <span onmouseout="hideTip(event, 'fs28', 192)" onmouseover="showTip(event, 'fs28', 192)" class="i">b</span> <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs46', 193)" onmouseover="showTip(event, 'fs46', 193)" class="i">richardsonRows</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs34', 194)" onmouseover="showTip(event, 'fs34', 194)" class="t">List</span><span class="o">&lt;</span><span onmouseout="hideTip(event, 'fs35', 195)" onmouseover="showTip(event, 'fs35', 195)" class="t">float</span> <span onmouseout="hideTip(event, 'fs36', 196)" onmouseover="showTip(event, 'fs36', 196)" class="t">array</span><span class="o">&gt;</span>()
    <span class="k">let</span> <span class="k">mutable</span> <span onmouseout="hideTip(event, 'fs48', 197)" onmouseover="showTip(event, 'fs48', 197)" class="v">h</span> <span class="o">=</span> (<span onmouseout="hideTip(event, 'fs28', 198)" onmouseover="showTip(event, 'fs28', 198)" class="i">b</span><span class="o">-</span><span onmouseout="hideTip(event, 'fs27', 199)" onmouseover="showTip(event, 'fs27', 199)" class="i">a</span>)<span class="o">*</span><span class="n">0.5</span>
    <span onmouseout="hideTip(event, 'fs46', 200)" onmouseover="showTip(event, 'fs46', 200)" class="i">richardsonRows</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs47', 201)" onmouseover="showTip(event, 'fs47', 201)" class="f">Add</span> ([|(<span onmouseout="hideTip(event, 'fs23', 202)" onmouseover="showTip(event, 'fs23', 202)" class="f">f</span> <span onmouseout="hideTip(event, 'fs27', 203)" onmouseover="showTip(event, 'fs27', 203)" class="i">a</span><span class="o">+</span><span onmouseout="hideTip(event, 'fs23', 204)" onmouseover="showTip(event, 'fs23', 204)" class="f">f</span> <span onmouseout="hideTip(event, 'fs28', 205)" onmouseover="showTip(event, 'fs28', 205)" class="i">b</span>)<span class="o">*</span><span onmouseout="hideTip(event, 'fs48', 206)" onmouseover="showTip(event, 'fs48', 206)" class="v">h</span>|])
    <span class="k">let</span> <span class="k">rec</span> <span onmouseout="hideTip(event, 'fs49', 207)" onmouseover="showTip(event, 'fs49', 207)" class="f">run</span> () <span class="o">=</span>
        <span class="k">let</span> <span onmouseout="hideTip(event, 'fs50', 208)" onmouseover="showTip(event, 'fs50', 208)" class="i">lastRow</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs29', 209)" onmouseover="showTip(event, 'fs29', 209)" class="t">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs51', 210)" onmouseover="showTip(event, 'fs51', 210)" class="f">last</span> <span onmouseout="hideTip(event, 'fs46', 211)" onmouseover="showTip(event, 'fs46', 211)" class="i">richardsonRows</span>
        <span class="k">let</span> <span onmouseout="hideTip(event, 'fs52', 212)" onmouseover="showTip(event, 'fs52', 212)" class="i">row</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs53', 213)" onmouseover="showTip(event, 'fs53', 213)" class="t">Array</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs54', 214)" onmouseover="showTip(event, 'fs54', 214)" class="f">zeroCreate</span> (<span onmouseout="hideTip(event, 'fs53', 215)" onmouseover="showTip(event, 'fs53', 215)" class="t">Array</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs55', 216)" onmouseover="showTip(event, 'fs55', 216)" class="f">length</span> <span onmouseout="hideTip(event, 'fs50', 217)" onmouseover="showTip(event, 'fs50', 217)" class="i">lastRow</span><span class="o">+</span><span class="n">1</span>)
        <span onmouseout="hideTip(event, 'fs52', 218)" onmouseover="showTip(event, 'fs52', 218)" class="i">row</span><span class="o">.</span>[<span class="n">0</span>] <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs59', 219)" onmouseover="showTip(event, 'fs59', 219)" class="f">integralEstimateIterative</span> <span onmouseout="hideTip(event, 'fs23', 220)" onmouseover="showTip(event, 'fs23', 220)" class="f">f</span> <span onmouseout="hideTip(event, 'fs27', 221)" onmouseover="showTip(event, 'fs27', 221)" class="i">a</span> <span onmouseout="hideTip(event, 'fs28', 222)" onmouseover="showTip(event, 'fs28', 222)" class="i">b</span> <span onmouseout="hideTip(event, 'fs50', 223)" onmouseover="showTip(event, 'fs50', 223)" class="i">lastRow</span><span class="o">.</span>[<span class="n">0</span>] <span onmouseout="hideTip(event, 'fs48', 224)" onmouseover="showTip(event, 'fs48', 224)" class="v">h</span>
        <span class="k">let</span> <span class="k">mutable</span> <span onmouseout="hideTip(event, 'fs56', 225)" onmouseover="showTip(event, 'fs56', 225)" class="v">pow4</span> <span class="o">=</span> <span class="n">4.0</span>
        <span class="k">for</span> <span onmouseout="hideTip(event, 'fs57', 226)" onmouseover="showTip(event, 'fs57', 226)" class="i">i</span> <span class="o">=</span> <span class="n">0</span> <span class="k">to</span> <span onmouseout="hideTip(event, 'fs53', 227)" onmouseover="showTip(event, 'fs53', 227)" class="t">Array</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs55', 228)" onmouseover="showTip(event, 'fs55', 228)" class="f">length</span> <span onmouseout="hideTip(event, 'fs50', 229)" onmouseover="showTip(event, 'fs50', 229)" class="i">lastRow</span><span class="o">-</span><span class="n">1</span> <span class="k">do</span>
            <span onmouseout="hideTip(event, 'fs52', 230)" onmouseover="showTip(event, 'fs52', 230)" class="i">row</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs57', 231)" onmouseover="showTip(event, 'fs57', 231)" class="i">i</span><span class="o">+</span><span class="n">1</span>] <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs40', 232)" onmouseover="showTip(event, 'fs40', 232)" class="f">richardsonFormula</span> <span onmouseout="hideTip(event, 'fs52', 233)" onmouseover="showTip(event, 'fs52', 233)" class="i">row</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs57', 234)" onmouseover="showTip(event, 'fs57', 234)" class="i">i</span>] <span onmouseout="hideTip(event, 'fs50', 235)" onmouseover="showTip(event, 'fs50', 235)" class="i">lastRow</span><span class="o">.</span>[<span onmouseout="hideTip(event, 'fs57', 236)" onmouseover="showTip(event, 'fs57', 236)" class="i">i</span>] <span onmouseout="hideTip(event, 'fs56', 237)" onmouseover="showTip(event, 'fs56', 237)" class="v">pow4</span>
            <span onmouseout="hideTip(event, 'fs56', 238)" onmouseover="showTip(event, 'fs56', 238)" class="v">pow4</span> <span class="o">&lt;-</span> <span onmouseout="hideTip(event, 'fs56', 239)" onmouseover="showTip(event, 'fs56', 239)" class="v">pow4</span><span class="o">*</span><span class="n">4.0</span>
        <span class="k">if</span> <span onmouseout="hideTip(event, 'fs31', 240)" onmouseover="showTip(event, 'fs31', 240)" class="f">stoppingCriteriaNonFunctional</span> <span onmouseout="hideTip(event, 'fs32', 241)" onmouseover="showTip(event, 'fs32', 241)" class="i">tol</span> <span onmouseout="hideTip(event, 'fs46', 242)" onmouseover="showTip(event, 'fs46', 242)" class="i">richardsonRows</span> <span class="k">then</span> <span onmouseout="hideTip(event, 'fs53', 243)" onmouseover="showTip(event, 'fs53', 243)" class="t">Array</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs58', 244)" onmouseover="showTip(event, 'fs58', 244)" class="f">last</span> <span onmouseout="hideTip(event, 'fs50', 245)" onmouseover="showTip(event, 'fs50', 245)" class="i">lastRow</span>
        <span class="k">else</span>
            <span onmouseout="hideTip(event, 'fs46', 246)" onmouseover="showTip(event, 'fs46', 246)" class="i">richardsonRows</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs47', 247)" onmouseover="showTip(event, 'fs47', 247)" class="f">Add</span> <span onmouseout="hideTip(event, 'fs52', 248)" onmouseover="showTip(event, 'fs52', 248)" class="i">row</span>
            <span onmouseout="hideTip(event, 'fs48', 249)" onmouseover="showTip(event, 'fs48', 249)" class="v">h</span><span class="o">&lt;-</span><span onmouseout="hideTip(event, 'fs48', 250)" onmouseover="showTip(event, 'fs48', 250)" class="v">h</span><span class="o">*</span><span class="n">0.5</span>
            <span onmouseout="hideTip(event, 'fs49', 251)" onmouseover="showTip(event, 'fs49', 251)" class="f">run</span>()
    <span onmouseout="hideTip(event, 'fs49', 252)" onmouseover="showTip(event, 'fs49', 252)" class="f">run</span>()
    
</code></pre></td>
</tr>
</table>
<h2>The refactor</h2>
<p>There is a lot of duplicate code in the functions above.
The object-oriented solution to this is the <a href="https://en.wikipedia.org/wiki/Template_method_pattern">Template Method</a> design pattern.
The downside of this approach is that it results in a lot of boiler-plate code with state being shared across multiple classes.</p>
<p>Leif Battermann has a very good <a href="http://blog.leifbattermann.de/2016/03/06/template-method-pattern-there-might-be-a-better-way/">post</a>
on how this can be solved in a functional way using higher-order functions. This results in much more modular and testable code.</p>
<p>Unfortunatly in our case higher-order functions alone will not solve the problem.
The integral estimate needs the previous estimate for its calculation.
This difference in state requirements means the higher-order function would need different signatures for the derivative and integral.</p>
<p>The solution can be found in the excellent paper <a href="http://www.cse.chalmers.se/~rjmh/Papers/whyfp.pdf">Why Functional Programming Matters</a> by John Hughes.</p>
<p>Lazy evaluation allows us to cleanly split the implementation into three parts:</p>
<ol>
<li>A function that produces an infinite sequence of function estimates.</li>
<li>A function that produces a sequence of Richardson estimates from a sequence of function estimates.</li>
<li>A function that iterates a sequence of Richardson estimates and stops at a desired accuracy.</li>
</ol>
<h2>Final code</h2>
<table class="pre"><tr><td class="lines"><pre class="fssnip"><span class="l"> 1: </span>
<span class="l"> 2: </span>
<span class="l"> 3: </span>
<span class="l"> 4: </span>
<span class="l"> 5: </span>
<span class="l"> 6: </span>
<span class="l"> 7: </span>
<span class="l"> 8: </span>
<span class="l"> 9: </span>
<span class="l">10: </span>
<span class="l">11: </span>
<span class="l">12: </span>
<span class="l">13: </span>
<span class="l">14: </span>
<span class="l">15: </span>
<span class="l">16: </span>
<span class="l">17: </span>
<span class="l">18: </span>
<span class="l">19: </span>
<span class="l">20: </span>
<span class="l">21: </span>
<span class="l">22: </span>
<span class="l">23: </span>
<span class="l">24: </span>
<span class="l">25: </span>
<span class="l">26: </span>
</pre></td>
<td class="snippet"><pre class="fssnip highlighted"><code lang="fsharp"><span class="c">/// Infinite sequence of derivative estimates.</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs62', 253)" onmouseover="showTip(event, 'fs62', 253)" class="f">derivativeEstimates</span> <span onmouseout="hideTip(event, 'fs23', 254)" onmouseover="showTip(event, 'fs23', 254)" class="f">f</span> <span onmouseout="hideTip(event, 'fs24', 255)" onmouseover="showTip(event, 'fs24', 255)" class="i">x</span> <span onmouseout="hideTip(event, 'fs45', 256)" onmouseover="showTip(event, 'fs45', 256)" class="i">h0</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs29', 257)" onmouseover="showTip(event, 'fs29', 257)" class="t">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs6', 258)" onmouseover="showTip(event, 'fs6', 258)" class="f">unfoldInf</span> (<span class="o">(*)</span><span class="n">0.5</span>) <span onmouseout="hideTip(event, 'fs45', 259)" onmouseover="showTip(event, 'fs45', 259)" class="i">h0</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs29', 260)" onmouseover="showTip(event, 'fs29', 260)" class="t">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs63', 261)" onmouseover="showTip(event, 'fs63', 261)" class="f">map</span> (<span onmouseout="hideTip(event, 'fs22', 262)" onmouseover="showTip(event, 'fs22', 262)" class="f">derivativeEstimate</span> <span onmouseout="hideTip(event, 'fs23', 263)" onmouseover="showTip(event, 'fs23', 263)" class="f">f</span> <span onmouseout="hideTip(event, 'fs24', 264)" onmouseover="showTip(event, 'fs24', 264)" class="i">x</span>)        

<span class="c">/// Infinte sequence of integral estimates.</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs64', 265)" onmouseover="showTip(event, 'fs64', 265)" class="f">integralEstimates</span> <span onmouseout="hideTip(event, 'fs23', 266)" onmouseover="showTip(event, 'fs23', 266)" class="f">f</span> <span onmouseout="hideTip(event, 'fs27', 267)" onmouseover="showTip(event, 'fs27', 267)" class="i">a</span> <span onmouseout="hideTip(event, 'fs28', 268)" onmouseover="showTip(event, 'fs28', 268)" class="i">b</span> <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs45', 269)" onmouseover="showTip(event, 'fs45', 269)" class="i">h0</span> <span class="o">=</span> (<span onmouseout="hideTip(event, 'fs28', 270)" onmouseover="showTip(event, 'fs28', 270)" class="i">b</span><span class="o">-</span><span onmouseout="hideTip(event, 'fs27', 271)" onmouseover="showTip(event, 'fs27', 271)" class="i">a</span>)<span class="o">*</span><span class="n">0.5</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs65', 272)" onmouseover="showTip(event, 'fs65', 272)" class="i">i0</span> <span class="o">=</span> (<span onmouseout="hideTip(event, 'fs23', 273)" onmouseover="showTip(event, 'fs23', 273)" class="f">f</span> <span onmouseout="hideTip(event, 'fs27', 274)" onmouseover="showTip(event, 'fs27', 274)" class="i">a</span><span class="o">+</span><span onmouseout="hideTip(event, 'fs23', 275)" onmouseover="showTip(event, 'fs23', 275)" class="f">f</span> <span onmouseout="hideTip(event, 'fs28', 276)" onmouseover="showTip(event, 'fs28', 276)" class="i">b</span>)<span class="o">*</span><span onmouseout="hideTip(event, 'fs45', 277)" onmouseover="showTip(event, 'fs45', 277)" class="i">h0</span>            
    <span onmouseout="hideTip(event, 'fs29', 278)" onmouseover="showTip(event, 'fs29', 278)" class="t">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs6', 279)" onmouseover="showTip(event, 'fs6', 279)" class="f">unfoldInf</span> (<span class="o">(*)</span><span class="n">0.5</span>) <span onmouseout="hideTip(event, 'fs45', 280)" onmouseover="showTip(event, 'fs45', 280)" class="i">h0</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs29', 281)" onmouseover="showTip(event, 'fs29', 281)" class="t">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs66', 282)" onmouseover="showTip(event, 'fs66', 282)" class="f">scan</span> (<span onmouseout="hideTip(event, 'fs59', 283)" onmouseover="showTip(event, 'fs59', 283)" class="f">integralEstimateIterative</span> <span onmouseout="hideTip(event, 'fs23', 284)" onmouseover="showTip(event, 'fs23', 284)" class="f">f</span> <span onmouseout="hideTip(event, 'fs27', 285)" onmouseover="showTip(event, 'fs27', 285)" class="i">a</span> <span onmouseout="hideTip(event, 'fs28', 286)" onmouseover="showTip(event, 'fs28', 286)" class="i">b</span>) <span onmouseout="hideTip(event, 'fs65', 287)" onmouseover="showTip(event, 'fs65', 287)" class="i">i0</span>

<span class="c">/// Richardson extrapolation for a given estimate sequence.</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs67', 288)" onmouseover="showTip(event, 'fs67', 288)" class="f">richardsonExtrapolation</span> <span onmouseout="hideTip(event, 'fs68', 289)" onmouseover="showTip(event, 'fs68', 289)" class="i">s</span> <span class="o">=</span>
    <span class="k">let</span> <span onmouseout="hideTip(event, 'fs69', 290)" onmouseover="showTip(event, 'fs69', 290)" class="f">createRow</span> <span onmouseout="hideTip(event, 'fs70', 291)" onmouseover="showTip(event, 'fs70', 291)" class="i">previousRow</span> <span onmouseout="hideTip(event, 'fs71', 292)" onmouseover="showTip(event, 'fs71', 292)" class="i">estimate_i</span> <span class="o">=</span>
        <span class="k">let</span> <span onmouseout="hideTip(event, 'fs72', 293)" onmouseover="showTip(event, 'fs72', 293)" class="f">richardsonAndPow4</span> (<span onmouseout="hideTip(event, 'fs41', 294)" onmouseover="showTip(event, 'fs41', 294)" class="i">currentRowR</span>,<span onmouseout="hideTip(event, 'fs43', 295)" onmouseover="showTip(event, 'fs43', 295)" class="i">pow4</span>) <span onmouseout="hideTip(event, 'fs42', 296)" onmouseover="showTip(event, 'fs42', 296)" class="i">previousRowR</span> <span class="o">=</span>
            <span onmouseout="hideTip(event, 'fs40', 297)" onmouseover="showTip(event, 'fs40', 297)" class="f">richardsonFormula</span> <span onmouseout="hideTip(event, 'fs41', 298)" onmouseover="showTip(event, 'fs41', 298)" class="i">currentRowR</span> <span onmouseout="hideTip(event, 'fs42', 299)" onmouseover="showTip(event, 'fs42', 299)" class="i">previousRowR</span> <span onmouseout="hideTip(event, 'fs43', 300)" onmouseover="showTip(event, 'fs43', 300)" class="i">pow4</span>, <span onmouseout="hideTip(event, 'fs43', 301)" onmouseover="showTip(event, 'fs43', 301)" class="i">pow4</span><span class="o">*</span><span class="n">4.0</span>
        <span onmouseout="hideTip(event, 'fs29', 302)" onmouseover="showTip(event, 'fs29', 302)" class="t">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs66', 303)" onmouseover="showTip(event, 'fs66', 303)" class="f">scan</span> <span onmouseout="hideTip(event, 'fs72', 304)" onmouseover="showTip(event, 'fs72', 304)" class="f">richardsonAndPow4</span> (<span onmouseout="hideTip(event, 'fs71', 305)" onmouseover="showTip(event, 'fs71', 305)" class="i">estimate_i</span>,<span class="n">4.0</span>) <span onmouseout="hideTip(event, 'fs70', 306)" onmouseover="showTip(event, 'fs70', 306)" class="i">previousRow</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs29', 307)" onmouseover="showTip(event, 'fs29', 307)" class="t">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs63', 308)" onmouseover="showTip(event, 'fs63', 308)" class="f">map</span> <span onmouseout="hideTip(event, 'fs73', 309)" onmouseover="showTip(event, 'fs73', 309)" class="f">fst</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs29', 310)" onmouseover="showTip(event, 'fs29', 310)" class="t">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs74', 311)" onmouseover="showTip(event, 'fs74', 311)" class="f">cache</span>
    <span onmouseout="hideTip(event, 'fs29', 312)" onmouseover="showTip(event, 'fs29', 312)" class="t">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs66', 313)" onmouseover="showTip(event, 'fs66', 313)" class="f">scan</span> <span onmouseout="hideTip(event, 'fs69', 314)" onmouseover="showTip(event, 'fs69', 314)" class="f">createRow</span> <span onmouseout="hideTip(event, 'fs29', 315)" onmouseover="showTip(event, 'fs29', 315)" class="t">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs75', 316)" onmouseover="showTip(event, 'fs75', 316)" class="i">empty</span> <span onmouseout="hideTip(event, 'fs68', 317)" onmouseover="showTip(event, 'fs68', 317)" class="i">s</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs29', 318)" onmouseover="showTip(event, 'fs29', 318)" class="t">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs76', 319)" onmouseover="showTip(event, 'fs76', 319)" class="f">tail</span>

<span class="c">/// Stopping criteria for a given accuracy and sequence of Richardson estimates.</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs77', 320)" onmouseover="showTip(event, 'fs77', 320)" class="f">stoppingCriteria</span> <span onmouseout="hideTip(event, 'fs32', 321)" onmouseover="showTip(event, 'fs32', 321)" class="i">tol</span> <span onmouseout="hideTip(event, 'fs78', 322)" onmouseover="showTip(event, 'fs78', 322)" class="i">s</span> <span class="o">=</span>
    <span onmouseout="hideTip(event, 'fs29', 323)" onmouseover="showTip(event, 'fs29', 323)" class="t">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs63', 324)" onmouseover="showTip(event, 'fs63', 324)" class="f">map</span> <span onmouseout="hideTip(event, 'fs29', 325)" onmouseover="showTip(event, 'fs29', 325)" class="t">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs51', 326)" onmouseover="showTip(event, 'fs51', 326)" class="f">last</span> <span onmouseout="hideTip(event, 'fs78', 327)" onmouseover="showTip(event, 'fs78', 327)" class="i">s</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs29', 328)" onmouseover="showTip(event, 'fs29', 328)" class="t">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs10', 329)" onmouseover="showTip(event, 'fs10', 329)" class="f">triplewise</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs29', 330)" onmouseover="showTip(event, 'fs29', 330)" class="t">Seq</span><span class="o">.</span><span onmouseout="hideTip(event, 'fs79', 331)" onmouseover="showTip(event, 'fs79', 331)" class="f">find</span> (<span class="k">fun</span> (<span onmouseout="hideTip(event, 'fs27', 332)" onmouseover="showTip(event, 'fs27', 332)" class="i">a</span>,<span onmouseout="hideTip(event, 'fs28', 333)" onmouseover="showTip(event, 'fs28', 333)" class="i">b</span>,<span onmouseout="hideTip(event, 'fs80', 334)" onmouseover="showTip(event, 'fs80', 334)" class="i">c</span>) <span class="k">-&gt;</span> <span onmouseout="hideTip(event, 'fs39', 335)" onmouseover="showTip(event, 'fs39', 335)" class="f">abs</span>(<span onmouseout="hideTip(event, 'fs27', 336)" onmouseover="showTip(event, 'fs27', 336)" class="i">a</span><span class="o">-</span><span onmouseout="hideTip(event, 'fs28', 337)" onmouseover="showTip(event, 'fs28', 337)" class="i">b</span>)<span class="o">&lt;=</span><span onmouseout="hideTip(event, 'fs32', 338)" onmouseover="showTip(event, 'fs32', 338)" class="i">tol</span> <span class="o">&amp;&amp;</span> <span onmouseout="hideTip(event, 'fs39', 339)" onmouseover="showTip(event, 'fs39', 339)" class="f">abs</span>(<span onmouseout="hideTip(event, 'fs28', 340)" onmouseover="showTip(event, 'fs28', 340)" class="i">b</span><span class="o">-</span><span onmouseout="hideTip(event, 'fs80', 341)" onmouseover="showTip(event, 'fs80', 341)" class="i">c</span>)<span class="o">&lt;=</span><span onmouseout="hideTip(event, 'fs32', 342)" onmouseover="showTip(event, 'fs32', 342)" class="i">tol</span>) <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs20', 343)" onmouseover="showTip(event, 'fs20', 343)" class="f">trd</span>

<span class="c">/// Derivative accurate to tol using Richardson extrapolation.</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs81', 344)" onmouseover="showTip(event, 'fs81', 344)" class="f">derivative</span> <span onmouseout="hideTip(event, 'fs32', 345)" onmouseover="showTip(event, 'fs32', 345)" class="i">tol</span> <span onmouseout="hideTip(event, 'fs23', 346)" onmouseover="showTip(event, 'fs23', 346)" class="f">f</span> <span onmouseout="hideTip(event, 'fs24', 347)" onmouseover="showTip(event, 'fs24', 347)" class="i">x</span> <span onmouseout="hideTip(event, 'fs45', 348)" onmouseover="showTip(event, 'fs45', 348)" class="i">h0</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs62', 349)" onmouseover="showTip(event, 'fs62', 349)" class="f">derivativeEstimates</span> <span onmouseout="hideTip(event, 'fs23', 350)" onmouseover="showTip(event, 'fs23', 350)" class="f">f</span> <span onmouseout="hideTip(event, 'fs24', 351)" onmouseover="showTip(event, 'fs24', 351)" class="i">x</span> <span onmouseout="hideTip(event, 'fs45', 352)" onmouseover="showTip(event, 'fs45', 352)" class="i">h0</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs67', 353)" onmouseover="showTip(event, 'fs67', 353)" class="f">richardsonExtrapolation</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs77', 354)" onmouseover="showTip(event, 'fs77', 354)" class="f">stoppingCriteria</span> <span onmouseout="hideTip(event, 'fs32', 355)" onmouseover="showTip(event, 'fs32', 355)" class="i">tol</span>

<span class="c">/// Intergral accurate to tol using Richardson extrapolation.</span>
<span class="k">let</span> <span onmouseout="hideTip(event, 'fs82', 356)" onmouseover="showTip(event, 'fs82', 356)" class="f">integral</span> <span onmouseout="hideTip(event, 'fs32', 357)" onmouseover="showTip(event, 'fs32', 357)" class="i">tol</span> <span onmouseout="hideTip(event, 'fs23', 358)" onmouseover="showTip(event, 'fs23', 358)" class="f">f</span> <span onmouseout="hideTip(event, 'fs27', 359)" onmouseover="showTip(event, 'fs27', 359)" class="i">a</span> <span onmouseout="hideTip(event, 'fs28', 360)" onmouseover="showTip(event, 'fs28', 360)" class="i">b</span> <span class="o">=</span> <span onmouseout="hideTip(event, 'fs64', 361)" onmouseover="showTip(event, 'fs64', 361)" class="f">integralEstimates</span> <span onmouseout="hideTip(event, 'fs23', 362)" onmouseover="showTip(event, 'fs23', 362)" class="f">f</span> <span onmouseout="hideTip(event, 'fs27', 363)" onmouseover="showTip(event, 'fs27', 363)" class="i">a</span> <span onmouseout="hideTip(event, 'fs28', 364)" onmouseover="showTip(event, 'fs28', 364)" class="i">b</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs67', 365)" onmouseover="showTip(event, 'fs67', 365)" class="f">richardsonExtrapolation</span> <span class="o">|&gt;</span> <span onmouseout="hideTip(event, 'fs77', 366)" onmouseover="showTip(event, 'fs77', 366)" class="f">stoppingCriteria</span> <span onmouseout="hideTip(event, 'fs32', 367)" onmouseover="showTip(event, 'fs32', 367)" class="i">tol</span>
</code></pre></td>
</tr>
</table>
<h2>Conclusion</h2>
<p>'Lazy evaluation makes it practical to modularize a program as a generator that constructs a large number of possible answers, and a selector that chooses the appropriate one.'
Without it either state has to be fully generated upfront or generation and consumption has to be done in the same place.</p>
<p>Higher-order functions and lazy evaluation are applicable across many software areas not just numeric algorithms.
The why functional programming matters paper has examples of their use in game artificial intelligence, and the conclusion also lists a number of other areas.</p>
<p>Modularity is the most important concept in software design. It makes software easier to write, understand, test and reuse.</p>


<div class="tip" id="fs1">module Main</div>
<div class="tip" id="fs2">namespace System</div>
<div class="tip" id="fs3">namespace System.Collections</div>
<div class="tip" id="fs4">namespace System.Collections.Generic</div>
<div class="tip" id="fs5">module Seq<br /><br />from Microsoft.FSharp.Collections</div>
<div class="tip" id="fs6">val unfoldInf : f:(&#39;a -&gt; &#39;a) -&gt; s:&#39;a -&gt; seq&lt;&#39;a&gt;<br /><br />Full name: Main.Seq.unfoldInf<br /><em><br /><br />&#160;Returns an infinite sequence that contains the elements generated by the given computation.</em></div>
<div class="tip" id="fs7">val f : (&#39;a -&gt; &#39;a)</div>
<div class="tip" id="fs8">val s : &#39;a</div>
<div class="tip" id="fs9">Multiple items<br />val seq : sequence:seq&lt;&#39;T&gt; -&gt; seq&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Core.Operators.seq<br /><br />--------------------<br />type seq&lt;&#39;T&gt; = IEnumerable&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Collections.seq&lt;_&gt;</div>
<div class="tip" id="fs10">val triplewise : s:seq&lt;&#39;a&gt; -&gt; seq&lt;&#39;a * &#39;a * &#39;a&gt;<br /><br />Full name: Main.Seq.triplewise<br /><em><br /><br />&#160;Returns a sequence of each element in the input and its two predecessors.</em></div>
<div class="tip" id="fs11">val s : seq&lt;&#39;a&gt;</div>
<div class="tip" id="fs12">val e : IEnumerator&lt;&#39;a&gt;</div>
<div class="tip" id="fs13">IEnumerable.GetEnumerator() : IEnumerator&lt;&#39;a&gt;</div>
<div class="tip" id="fs14">System.Collections.IEnumerator.MoveNext() : bool</div>
<div class="tip" id="fs15">val i : &#39;a ref</div>
<div class="tip" id="fs16">Multiple items<br />val ref : value:&#39;T -&gt; &#39;T ref<br /><br />Full name: Microsoft.FSharp.Core.Operators.ref<br /><br />--------------------<br />type &#39;T ref = Ref&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Core.ref&lt;_&gt;</div>
<div class="tip" id="fs17">property IEnumerator.Current: &#39;a</div>
<div class="tip" id="fs18">val j : &#39;a ref</div>
<div class="tip" id="fs19">val k : &#39;a</div>
<div class="tip" id="fs20">val trd : &#39;a * &#39;b * i:&#39;c -&gt; &#39;c<br /><br />Full name: Main.trd<br /><em><br /><br />&#160;Returns the third item from a 3-tuple.</em></div>
<div class="tip" id="fs21">val i : &#39;c</div>
<div class="tip" id="fs22">val derivativeEstimate : f:(float -&gt; float) -&gt; x:float -&gt; h:float -&gt; float<br /><br />Full name: Main.derivativeEstimate<br /><em><br /><br />&#160;Derivative estimate</em></div>
<div class="tip" id="fs23">val f : (float -&gt; float)</div>
<div class="tip" id="fs24">val x : float</div>
<div class="tip" id="fs25">val h : float</div>
<div class="tip" id="fs26">val integralEstimate : f:(float -&gt; float) -&gt; a:float -&gt; b:float -&gt; h:float -&gt; float<br /><br />Full name: Main.integralEstimate<br /><em><br /><br />&#160;Integral estimate (h = (b-a)/n where n is an integer)</em></div>
<div class="tip" id="fs27">val a : float</div>
<div class="tip" id="fs28">val b : float</div>
<div class="tip" id="fs29">Multiple items<br />module Seq<br /><br />from Main<br /><br />--------------------<br />module Seq<br /><br />from Microsoft.FSharp.Collections</div>
<div class="tip" id="fs30">val sumBy : projection:(&#39;T -&gt; &#39;U) -&gt; source:seq&lt;&#39;T&gt; -&gt; &#39;U (requires member ( + ) and member get_Zero)<br /><br />Full name: Microsoft.FSharp.Collections.Seq.sumBy</div>
<div class="tip" id="fs31">val stoppingCriteriaNonFunctional : tol:float -&gt; rows:List&lt;float array&gt; -&gt; bool<br /><br />Full name: Main.stoppingCriteriaNonFunctional<br /><em><br /><br />&#160;Stopping criteria for a given accuracy and list of Richardson estimates.</em></div>
<div class="tip" id="fs32">val tol : float</div>
<div class="tip" id="fs33">val rows : List&lt;float array&gt;</div>
<div class="tip" id="fs34">Multiple items<br />type List&lt;&#39;T&gt; =<br />&#160;&#160;new : unit -&gt; List&lt;&#39;T&gt; + 2 overloads<br />&#160;&#160;member Add : item:&#39;T -&gt; unit<br />&#160;&#160;member AddRange : collection:IEnumerable&lt;&#39;T&gt; -&gt; unit<br />&#160;&#160;member AsReadOnly : unit -&gt; ReadOnlyCollection&lt;&#39;T&gt;<br />&#160;&#160;member BinarySearch : item:&#39;T -&gt; int + 2 overloads<br />&#160;&#160;member Capacity : int with get, set<br />&#160;&#160;member Clear : unit -&gt; unit<br />&#160;&#160;member Contains : item:&#39;T -&gt; bool<br />&#160;&#160;member ConvertAll&lt;&#39;TOutput&gt; : converter:Converter&lt;&#39;T, &#39;TOutput&gt; -&gt; List&lt;&#39;TOutput&gt;<br />&#160;&#160;member CopyTo : array:&#39;T[] -&gt; unit + 2 overloads<br />&#160;&#160;...<br />&#160;&#160;nested type Enumerator<br /><br />Full name: System.Collections.Generic.List&lt;_&gt;<br /><br />--------------------<br />List() : unit<br />List(capacity: int) : unit<br />List(collection: IEnumerable&lt;&#39;T&gt;) : unit</div>
<div class="tip" id="fs35">Multiple items<br />val float : value:&#39;T -&gt; float (requires member op_Explicit)<br /><br />Full name: Microsoft.FSharp.Core.Operators.float<br /><br />--------------------<br />type float = System.Double<br /><br />Full name: Microsoft.FSharp.Core.float<br /><br />--------------------<br />type float&lt;&#39;Measure&gt; = float<br /><br />Full name: Microsoft.FSharp.Core.float&lt;_&gt;</div>
<div class="tip" id="fs36">type &#39;T array = &#39;T []<br /><br />Full name: Microsoft.FSharp.Core.array&lt;_&gt;</div>
<div class="tip" id="fs37">val c : int</div>
<div class="tip" id="fs38">property List.Count: int</div>
<div class="tip" id="fs39">val abs : value:&#39;T -&gt; &#39;T (requires member Abs)<br /><br />Full name: Microsoft.FSharp.Core.Operators.abs</div>
<div class="tip" id="fs40">val richardsonFormula : currentRowR:float -&gt; previousRowR:float -&gt; pow4:float -&gt; float<br /><br />Full name: Main.richardsonFormula<br /><em><br /><br />&#160;The Richardson formula for a function estimate that has even power error term.</em></div>
<div class="tip" id="fs41">val currentRowR : float</div>
<div class="tip" id="fs42">val previousRowR : float</div>
<div class="tip" id="fs43">val pow4 : float</div>
<div class="tip" id="fs44">val derivativeNonFunctional : tol:float -&gt; h0:float -&gt; f:(float -&gt; float) -&gt; x:float -&gt; float<br /><br />Full name: Main.derivativeNonFunctional<br /><em><br /><br />&#160;Derivative accurate to tol using Richardson extrapolation </em></div>
<div class="tip" id="fs45">val h0 : float</div>
<div class="tip" id="fs46">val richardsonRows : List&lt;float array&gt;</div>
<div class="tip" id="fs47">List.Add(item: float array) : unit</div>
<div class="tip" id="fs48">val mutable h : float</div>
<div class="tip" id="fs49">val run : (unit -&gt; float)</div>
<div class="tip" id="fs50">val lastRow : float array</div>
<div class="tip" id="fs51">val last : source:seq&lt;&#39;T&gt; -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Collections.Seq.last</div>
<div class="tip" id="fs52">val row : float []</div>
<div class="tip" id="fs53">module Array<br /><br />from Microsoft.FSharp.Collections</div>
<div class="tip" id="fs54">val zeroCreate : count:int -&gt; &#39;T []<br /><br />Full name: Microsoft.FSharp.Collections.Array.zeroCreate</div>
<div class="tip" id="fs55">val length : array:&#39;T [] -&gt; int<br /><br />Full name: Microsoft.FSharp.Collections.Array.length</div>
<div class="tip" id="fs56">val mutable pow4 : float</div>
<div class="tip" id="fs57">val i : int</div>
<div class="tip" id="fs58">val last : array:&#39;T [] -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Collections.Array.last</div>
<div class="tip" id="fs59">val integralEstimateIterative : f:(float -&gt; float) -&gt; a:float -&gt; b:float -&gt; previousEstimate:float -&gt; h:float -&gt; float<br /><br />Full name: Main.integralEstimateIterative<br /><em><br /><br />&#160;Iterative integral estimate (h is half the value used in the previous estimate)</em></div>
<div class="tip" id="fs60">val previousEstimate : float</div>
<div class="tip" id="fs61">val integralNonFunctional : tol:float -&gt; f:(float -&gt; float) -&gt; a:float -&gt; b:float -&gt; float<br /><br />Full name: Main.integralNonFunctional<br /><em><br /><br />&#160;Intergral accurate to tol using Richardson extrapolation </em></div>
<div class="tip" id="fs62">val derivativeEstimates : f:(float -&gt; float) -&gt; x:float -&gt; h0:float -&gt; seq&lt;float&gt;<br /><br />Full name: Main.derivativeEstimates<br /><em><br /><br />&#160;Infinite sequence of derivative estimates.</em></div>
<div class="tip" id="fs63">val map : mapping:(&#39;T -&gt; &#39;U) -&gt; source:seq&lt;&#39;T&gt; -&gt; seq&lt;&#39;U&gt;<br /><br />Full name: Microsoft.FSharp.Collections.Seq.map</div>
<div class="tip" id="fs64">val integralEstimates : f:(float -&gt; float) -&gt; a:float -&gt; b:float -&gt; seq&lt;float&gt;<br /><br />Full name: Main.integralEstimates<br /><em><br /><br />&#160;Infinte sequence of integral estimates.</em></div>
<div class="tip" id="fs65">val i0 : float</div>
<div class="tip" id="fs66">val scan : folder:(&#39;State -&gt; &#39;T -&gt; &#39;State) -&gt; state:&#39;State -&gt; source:seq&lt;&#39;T&gt; -&gt; seq&lt;&#39;State&gt;<br /><br />Full name: Microsoft.FSharp.Collections.Seq.scan</div>
<div class="tip" id="fs67">val richardsonExtrapolation : s:seq&lt;float&gt; -&gt; seq&lt;seq&lt;float&gt;&gt;<br /><br />Full name: Main.richardsonExtrapolation<br /><em><br /><br />&#160;Richardson extrapolation for a given estimate sequence.</em></div>
<div class="tip" id="fs68">val s : seq&lt;float&gt;</div>
<div class="tip" id="fs69">val createRow : (seq&lt;float&gt; -&gt; float -&gt; seq&lt;float&gt;)</div>
<div class="tip" id="fs70">val previousRow : seq&lt;float&gt;</div>
<div class="tip" id="fs71">val estimate_i : float</div>
<div class="tip" id="fs72">val richardsonAndPow4 : (float * float -&gt; float -&gt; float * float)</div>
<div class="tip" id="fs73">val fst : tuple:(&#39;T1 * &#39;T2) -&gt; &#39;T1<br /><br />Full name: Microsoft.FSharp.Core.Operators.fst</div>
<div class="tip" id="fs74">val cache : source:seq&lt;&#39;T&gt; -&gt; seq&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Collections.Seq.cache</div>
<div class="tip" id="fs75">val empty&lt;&#39;T&gt; : seq&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Collections.Seq.empty</div>
<div class="tip" id="fs76">val tail : source:seq&lt;&#39;T&gt; -&gt; seq&lt;&#39;T&gt;<br /><br />Full name: Microsoft.FSharp.Collections.Seq.tail</div>
<div class="tip" id="fs77">val stoppingCriteria : tol:float -&gt; s:seq&lt;#seq&lt;float&gt;&gt; -&gt; float<br /><br />Full name: Main.stoppingCriteria<br /><em><br /><br />&#160;Stopping criteria for a given accuracy and sequence of Richardson estimates.</em></div>
<div class="tip" id="fs78">val s : seq&lt;#seq&lt;float&gt;&gt;</div>
<div class="tip" id="fs79">val find : predicate:(&#39;T -&gt; bool) -&gt; source:seq&lt;&#39;T&gt; -&gt; &#39;T<br /><br />Full name: Microsoft.FSharp.Collections.Seq.find</div>
<div class="tip" id="fs80">val c : float</div>
<div class="tip" id="fs81">val derivative : tol:float -&gt; f:(float -&gt; float) -&gt; x:float -&gt; h0:float -&gt; float<br /><br />Full name: Main.derivative<br /><em><br /><br />&#160;Derivative accurate to tol using Richardson extrapolation.</em></div>
<div class="tip" id="fs82">val integral : tol:float -&gt; f:(float -&gt; float) -&gt; a:float -&gt; b:float -&gt; float<br /><br />Full name: Main.integral<br /><em><br /><br />&#160;Intergral accurate to tol using Richardson extrapolation.</em></div>
